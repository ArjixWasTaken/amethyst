#!/bin/env amber

import { array_shift } from "std/array"
import { file_exists } from "std/fs"
import { is_command } from "std/env"
import { join } from "std/text"

import { fatal } from "./lib/utils.ab"
import { locate_project, get_project_property } from "./lib/project.ab"
import { is_available_locally, execute_script } from "./lib/amber_manager.ab"

import { cmd_help } from "./commands/help.ab"
import { cmd_init } from "./commands/init.ab"
import { cmd_info } from "./commands/info.ab"

// TODO: Remove any unnecessary dependencies
const deps = ["uname", "curl", "jq", "python"]
let missing = [Text]

for dep in deps {
    if not is_command(dep) {
        missing += [dep]
    }
}

if len(missing) > 0 {
    fatal("Missing dependencies: {join(missing, ",")}")
}

main(args) {
    let arguments = args
    array_shift(arguments)

    let arg = array_shift(arguments)

    const project = locate_project()
    if file_exists(arg) and project[0] == "yes" {
        const version = get_project_property(project[1], "amethyst", "amber-version")

        if is_available_locally(version) {
            execute_script(version, arg)
            // execute_script uses exec, so really, this *is* unreachable
            // but just in case
            exit(0)
        }

        fatal("Amber version {version} is not available locally.")
    }

    if {
        // TODO: `help` doesn't work if amber is directly executing this file
        // Maybe we should report this to the amber team?
        arg == "help": cmd_help(arguments)
        arg == "init": cmd_init(arguments)
        arg == "info": cmd_info(arguments)
    }
}
